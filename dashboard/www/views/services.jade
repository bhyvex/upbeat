extends layout

block content
  h3
    a(href="/services/#{serviceName}")= serviceName

  dl.dl-horizontal: each sensor, sensorName in service.sensors
    dt: .canvas(data-name="#{serviceName}/#{sensorName}")
    dd: a(href="/services/#{serviceName}/sensors/#{sensorName}", style="color:#{color(sensor)}", style="line-height: 55px;")= sensorName

  :mochi
    var svgs = {};

    $(#{ 
      $('.canvas').each(#{
        var name = $(this).data('name');
        var svg = d3.select(this)
          .append('svg')
          .attr('height', 50)
          .attr('width', 50);

        var circle = svg.append('svg:circle')
          .attr('r', 50)
          .attr('fill', 'green')
          .attr('cx', 25)
          .attr('cy', 25);

        svgs[name] = circle;
      });

      setInterval(getData, 5000);
      getData();
    });

    function getData() {
      $.get('/status.json', #(data) {
        for (var name in data) {
          var service = data[name];
          for (var sname in service) {
            var key = name + '/' + sname;
            animate(svgs[key], service[sname]);
          }
        }
      });
    }

    function animate(svg, data) {
      svg
        .attr('r', 0)
        .transition()
          .duration(1000)
          .attr('fill', 'green')
          .attr('r', 10);
    }
